#  ERaftKV RPC 

*注意：设计文档里面代码都是伪代码*

## 消息定义

* 投票请求

```
message request_vote_req 
{
    bool prevote;

    int64 term;

    int64 candidtate_id;

    int64 last_log_idx;

    int64 last_log_term;
}
```
* 投票响应

```
message request_vote_resp
{
    bool prevote;

    int64 request_term;

    int64 term;

    bool vote_granted;
}
```

* 日志项

```
enum entry_type
{
    NORMAL
    JOIN_NO_VOTE_NODE
    JOIN_NODE
    LEAVE_NODE
    NO_OP
}

message entry 
{
    int64 term;

    int64 id;

    entry_type type

    int64   data_size;

    bytes[] data;
}
```

* 追加日志请求

```
message appendentries_req
{
    int64 leader_id;

    string message_token;

    int64 term;

    int64 prev_log_idx;

    int64 prev_log_term;

    int64 leader_commit;

    int64 entries_size;

    entry[] enrires;
}
```

* 追加日志的响应
```
message appendentries_resp
{
    string message_token;

    int64 term;

    bool success

    int64 curr_index;
}
```

* 发送快照的请求
```
message snapshot_block
{
    int64 offset;

    bytes[] data;

    int64 block_size;

    bool is_last_chunk;
}

message snapshot_req
{
    int64 term;

    int64 leader_id;

    string message_token;

    int64 snapshot_index;

    int64 snapshot_term;

    snapshot_block block;
}
```

* 发送快照的响应

```
message snapshot_resp
{
    int64 term;

    string message_token;

    int64 offset;

    bool success;

    bool is_last_chunk;
}
```

## 服务定义

```
service request_vote(request_vote_req, request_vote_resp)
service append_entries(appendentries_req, appendentries_resp)
service snapshot(snapshot_req, snapshot_resp);
```

#  ERaftKV Raft 服务层数据结构以及操作接口

* raft_server 核心

```
StateEnum
{
    FOLLOWER
    PRECANDIDATE
    CANDIDATE
    LEADER
}

// server 上下文
class RaftServer
{
    // 成员变量
    int64 current_term;

    int64 voted_for;

    int64 commit_idx;

    int64 last_applied_idx;

    int64 last_applied_term;

    StateEnum state;

    int64 leader_id;

    NetworkInterface ntface;

    StorageInterface stface;

    RaftLog log_;
...

    //主要方法
    RaftServer(RaftLog* logImpl);

    Status SaveMetaData(int64 term, int64 vote);

    Status LoadMetaData();

    Node* JoinNode(int64 id, bool is_self);

    Status RemoveNode(Node* node);

    Status RunCycles();

    Status HandleRequestVoteReq(Node *from_node, RequestVoteReq* req, RequestVoteResp* resp)

    Status HandleRequestVoteResp(Node *from_node, RequestVoteResp* resp);

    Status HandleAppendEntriesReq(Node *from_node,
    AppendEntriesReq* req, AppendEntriesResp* resp);

    Status HandleAppendEntriesResp(Node *from_node,
    AppendEntriesResp* resp);

    Status HandleSnapshotReq(Node *from_node,
    SnapshotReq* req, SnapshotResp* resp);

    Status HandleSnapshotResp(Node *from_node,
    SnapshotResp* resp);

    Entry* ProposeEntry(Entry* ety);

    Status BecomeLeader();

    Status BeginSnapshot();

    Status EndSnapshot();

    bool  SnapshotRunning();

    Entry* GetLastAppliedEntry();

    int64 GetFirstEntryIdx();

    Status RestoreSnapshotAfterRestart();

    Status BeginLoadSnapshot(int64 last_included_term, int64 last_included_index);

    Status EndLoadSnapshot();

    Status ProposeReadReq();

    int64 GetLogsCountCanSnapshot();

    Status RestoreLog();

}

// 待应用层实现网络消息发送的接口

interface RaftNetworkInterface
{
    Status SendRequestVote(RaftServer* raft, Node* target_node, request_vote_req* req);

    Status SendAppendEntries(RaftServer* raft, Node* target_node, AppendEntriesReq* req);

    Status SendSnapshot(RaftServer* raft, Node* target_node, SnapshotReq* req);

    Status ConfChangeEvent(RaftServer* raft, Node* node, Entry* entry, EventType t);

    void StateChangeEvent(RaftServer* raft, StateEnum* state);
    ...
}

class GRpcRaftNetwork : public RaftNetworkInterface {

    // grpc 实现
    grpc::Channel* chan_;
}

// 待应用层实现，快照存储相关的接口
interface RaftStorageInterface
{

    Status LoadSnapshot(RaftServer* raft, int64 snapshot_index, int64 snapshot_term);

    Status GetSnapshotBlock(RaftServer* raft, Node* node, int64 offset, SnapshotBlock* block);

    Status StoreSnapshotBlock(RaftServer* raft, int64 snapshot_index, int64 offset, SnapshotBlock* block);

    Status ClearSnapshot(RaftServer* raft);

    Status SaveMeta(int64 term, int64 vote);

    Vec<Entry*> GetEntsToSend(RaftServer* raft, Node* node, int64 idx, int64 count);

    Status CreateSnapshot(string snapshot_dir);
    ...
}

class RocksDBRaftStorage : public RaftStorageInterface {

    // grpc 实现
    rocksdb::DB* kv_db_;
}


```


#  ERaftKV Raft 日志核心数据结构以及操作接口

```

class RaftLog
{

    uint64 count_;

    // 日志项缓存
    Vec<LogEntry*> ents_;

    LogStoreInterface* firstLogStore;

    LogStoreInterface* secLogStore;
    ...
}

// 待应用层实现的 log 具体存储的接口

interface LogStoreInterface
{
 
    void Init(RaftServer* raft)

    void Free();

    void Reset(int64 index, int64 term);

    Status Append(LogEntry *ety);

    Status EraseBefore(int64 firstIndex);

    Status EraseAfter(int64 fromIndex);

    LogEntry* Get(int64 index);

    Vec<LogEntry*> Gets(int64 firstIdx, int64 entCount)

    int64 FirstIndex();

    int64 LastIndex();

    int64 Count();

    Status SyncLogDB();
}

// 内存版本实现
class MemoryLogStorage : public LogStoreInterface {

    Vec<LogEntry*> ents_;
}

// rocksdb 版实现
class RocksDBLogStorage : public LogStoreInterface {

    Vec<rocksdb::DB*> ents_;
}

```

#  ERaftKV KvServer 层数据结构以及操作接口
```

class ERaftKvServer
{
    RaftServer raft_context_;
}

```

#  ERaftKV MetaServer 层数据结构以及操作接口
```
class ERaftMetaServer
{
    RaftServer raft_context_;    
}

```
